#include "jhi.h"
#include "teemanagement.h"

#include <cstdint>
#include <string>
#include <iostream>
#include <cstring>
#include <jhi.h>
#include "dbg.h"

using namespace std;

bool CheckJhiSuccess(JHI_RET status, string step)
{
    if (status != JHI_SUCCESS)
    {
        cout << " " << step << " failed. Status: " << JHIErrorToString(status) << endl;
        return false;
    }
    else
    {
        cout << " Success." << endl;
        return true;
    }
}

bool CheckTeeSuccess(JHI_RET status, string step)
{
	if (status != TEE_STATUS_SUCCESS)
	{
		cout << " " << step << " failed. Status: " << TEEErrorToString(status) << endl;
		return false;
	}
	else
	{
		cout << " Success." << endl;
		return true;
	}
}

#define PROD_APP_ID "00000000000000000000000000000001"
#define PROD_APP_BLOB_SIG_VER_1 "\x06\x00\x00\x00\xA1\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x86\x80\x00\x00\x27\x07\x10\x20\xDB\x00\x00\x00\x40\x00\x00\x00\x40\x00\x00\x00\x01\x00\x00\x00\x43\x53\x45\x58\x01\x00\x00\x00\xBD\x2F\xBA\x36\xA2\xD6\x4D\xAB\x93\x90\xFF\x6D\xA2\xFE\xF3\x1C\x04\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3D\x3D\x5B\x0C\x54\x4A\xBE\x71\xCE\xF0\x1E\x98\x3F\x1C\x48\x11\xAD\x90\x1D\x73\xA6\x9A\x8F\x90\x6D\xF3\xE0\x35\xB8\xF1\xF5\xC5\x08\x7F\x8B\xAD\x50\x55\xC8\x7C\x0A\xFE\xAD\x5A\xF1\x78\x29\xB8\x49\xA8\x7F\x7B\x9E\x39\xCB\xE8\x0A\x38\x8E\x3D\xE2\x45\x6B\x4C\x58\x34\xDC\x9B\x8F\x8F\x5B\xDD\x16\x12\x19\xC1\x17\x25\x8F\x72\xDD\xCD\x0F\xE2\x33\x0F\x1D\x7E\x50\x45\xB4\x6B\x69\xE4\x8E\x22\xD5\x95\x99\xB2\xCC\x6F\xCB\xB1\x19\xE7\x80\x07\x5F\x64\x4C\x3C\x8B\xE0\x06\x91\x56\x98\x52\x77\x29\x0F\x52\x45\x16\xC0\x39\x3A\x83\x27\xD3\x54\x9D\x65\x59\x09\x80\x16\xBF\x16\x9D\x7A\x48\x95\x62\x40\xEB\xA8\x79\x77\x83\xC8\x14\x33\x24\x8D\xA1\x50\x6D\x16\xA1\x88\xC0\x52\x0D\x01\x36\xEA\xEC\x84\x5D\x3F\xB0\xDC\x83\xAB\x92\x82\x8F\x64\x17\xAB\x18\x5E\x0C\xDC\x2D\x2E\x3A\xD0\x5B\x40\x60\x80\x06\x5B\x07\x89\x9B\x93\xB6\x00\xE1\xC9\x31\x6B\xD8\x38\x4C\x67\xBB\xDA\x1C\xDA\xBD\x53\x0D\x2B\xFB\xFA\x66\xE1\x35\xC6\x1B\x1F\xE6\x92\x9D\x59\xF5\x25\x42\xA7\x4A\xA0\xE8\x47\x7B\x23\x3D\x77\x4D\x42\x92\x98\x27\x62\xE7\xD6\xED\x9C\xFE\x12\x91\xD6\x01\x00\x01\x00\xF8\xF8\x16\x0C\x78\x51\x5D\x25\xD2\x45\x5F\xDE\x76\x4B\x63\xC6\xAE\xA0\x1E\xDC\xE3\x16\x19\x3C\x36\xE8\x30\x37\x38\x04\x55\x70\xC5\xA4\x3F\x70\xA3\xBA\xB7\x6E\x61\xD3\x9D\xCE\x1D\xFE\x69\x9B\x86\x37\x2B\x63\x4A\x78\x68\x9C\xE6\x6B\x68\x58\x6A\x3B\xD2\xCA\x00\x6C\x6C\x54\x03\xFF\xBD\xE8\x37\x8D\x00\x15\x4E\x1E\x74\x9B\xE2\x8F\x45\x55\x8B\x64\xF9\x2B\x62\x9C\x3C\xBB\x5A\xD3\x72\x4D\xE0\x2E\x51\xCD\x61\x0B\xD5\xB1\x88\x69\x05\x68\x12\xA5\x4C\x09\x36\x4D\xE1\xFB\xD1\x1B\x81\xEB\x84\x8F\xAF\x3F\xAA\xAD\xD1\x4E\x40\xB9\x36\x1D\x1B\x3E\x9E\xE4\x87\xA1\x35\x66\xFB\x92\x7F\xC1\xC5\x20\x31\x87\x99\x92\x63\x65\x58\xD8\x23\xBC\xBF\x3F\xF5\xC9\x8E\xA9\xB1\x9D\xB6\x4D\x7B\x2A\xBB\x8F\xB5\x9F\x47\xF5\x3E\xBF\xCA\xF5\x7A\x8C\xAA\x88\x80\x9F\xD0\xFE\x30\xA4\x81\x2E\x08\x7C\x76\x56\xDE\xE9\x78\xA0\x59\x0A\x19\xE3\x4F\x8D\x37\x2A\x50\xC0\x4D\x17\xAC\xB0\xE6\xCE\xE4\x8F\xFB\xF7\xCE\xDB\x54\x56\xC8\x3D\xFC\x27\xE7\x5D\x8B\xF0\xD4\xC4\x80\x75\xA2\x65\xB8\x92\x5E\xD6\x79\x21\xC6\x3E\xD6\x9D\x87\x88\x9E\x2D\x14\xB9\xF9\x33\x07\x8F\x00\x00\x00\x00\x42\x41\x43\x50\x01\x00\x00\x00\xE4\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x20\x00\x00\x00\xAC\x00\x00\x00\x05\x00\x00\x00\x81\x00\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x34\x2E\x31\x39\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x6C\x69\x62\x72\x61\x72\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x00\x00\x00\x02\x00\x00\x00\x6E\x0B\x49\x95\xD0\xA6\x19\xD7\xD2\x5B\x14\x08\x0E\xAE\x0F\xDC\x24\x30\x6C\xDD\xC1\xF3\x2A\x87\x0D\x87\x68\x51\xA6\xBF\xF0\x60\xDD\xDD\xDD\xDD\x20\x4E\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xE8\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0D\x00\x00\x00\xCC\x01\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x77\x72\x69\x74\x74\x65\x6E\x2E\x62\x79\x2E\x69\x6E\x74\x65\x6C\x00\x74\x72\x75\x65\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x34\x2E\x31\x39\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x6E\x64\x6F\x72\x00\x49\x6E\x74\x65\x6C\x20\x43\x6F\x72\x70\x6F\x72\x61\x74\x69\x6F\x6E\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x73\x68\x61\x72\x65\x64\x2E\x73\x65\x73\x73\x69\x6F\x6E\x2E\x73\x75\x70\x70\x6F\x72\x74\x00\x66\x61\x6C\x73\x65\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x6E\x61\x6D\x65\x00\x42\x69\x73\x74\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x6C\x69\x62\x72\x61\x72\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x66\x6C\x61\x73\x68\x2E\x71\x75\x6F\x74\x61\x00\x30\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x65\x6E\x74\x72\x79\x5F\x63\x6C\x61\x73\x73\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x61\x70\x70\x73\x2E\x62\x69\x73\x74\x50\x61\x63\x6B\x61\x67\x65\x2E\x42\x69\x73\x74\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x73\x63\x72\x69\x70\x74\x69\x6F\x6E\x00\x49\x6E\x74\x65\x6C\x28\x52\x29\x20\x44\x79\x6E\x61\x6D\x69\x63\x20\x41\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x20\x4C\x6F\x61\x64\x65\x72\x20\x74\x65\x73\x74\x20\x61\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x62\x75\x67\x2E\x65\x6E\x61\x62\x6C\x65\x00\x66\x61\x6C\x73\x65\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\xDD\xDD\xDD\xDD\x4A\x45\x46\x46\x01\x00\x00\x00\x78\x05\x00\x00\x00\x00\x04\x00\x01\x00\x04\x00\x0A\x00\x00\x00\x08\x00\x00\x00\x50\x02\x00\x00\xEC\x02\x00\x00\xA4\x03\x00\x00\x00\x00\x00\x00\x30\x00\x00\x00\x22\x00\x00\x00\x21\x00\x00\x00\xCC\x00\x00\x00\x28\x00\xA4\x00\x00\x00\xD8\x00\x1E\x00\xF2\x01\x24\x00\x00\x00\xA8\x00\x04\x00\x03\x00\x00\x00\x02\x00\x01\x00\x0A\x00\x00\x00\x00\x00\x00\x00\x22\x00\x02\x00\x1A\x00\xF8\x01\x01\x00\x00\x00\x22\x00\x02\x00\x1A\x00\xFC\x01\x02\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x00\x02\x03\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x04\x02\x04\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x04\x02\x05\x00\x00\x00\x22\x00\x64\x01\x1A\x00\x00\x00\x06\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x08\x02\x07\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x00\x02\x08\x00\x00\x00\x22\x00\x64\x01\x1A\x00\x00\x00\x09\x00\x00\x00\x22\x00\x02\x00\x1A\x00\x0C\x02\x04\x00\x00\x00\x01\x00\x00\x00\x22\x00\x01\x00\x01\x00\x04\x01\x02\x00\x00\x00\x22\x00\x01\x00\x02\x00\x12\x01\x03\x00\x00\x00\x22\x00\x03\x00\x01\x00\x52\x01\x00\x00\x00\x00\x22\x00\x00\x00\x08\x00\xCA\x01\x05\x00\x00\x00\x01\x00\x00\x00\x24\x00\x00\x00\x07\x00\x00\x00\x22\x00\x00\x00\x06\x00\x00\x00\x26\x00\x00\x00\x05\x00\x00\x00\x26\x00\x00\x00\x04\x00\x00\x00\x26\x00\x00\x00\x01\x00\x01\x00\x00\x00\x05\x00\x2A\xB7\xDC\x00\xB1\x00\x05\x00\x04\x00\xE8\x01\x38\x00\x10\x20\xBC\x64\x4D\x10\x20\xBC\x64\x4E\x2C\x03\x10\x20\x10\x08\xB8\x00\xEC\x00\x2C\x03\x2D\x03\x10\x20\xB8\x00\xF4\x00\x2C\x03\x2D\x03\x10\x20\xB8\x00\xFC\x00\x3C\xA7\x49\x01\x4D\x03\x3C\x1B\x99\x00\x50\x01\x03\xAC\x04\xAC\x04\x00\x04\x00\x00\x00\x70\x00\x1B\xCC\xBC\x01\x02\x00\x00\x00\x01\x00\x68\x01\x90\x01\x2A\xB7\xB4\x00\x3E\x1D\x9A\x00\x82\x01\x2A\xB2\x8C\x00\x03\xB2\x8C\x00\xBE\xB6\xE4\x00\xA7\x00\x8E\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x1D\xAC\x2C\xC6\xA4\x01\x2C\xBE\x9E\x00\xA4\x01\x2C\xBE\x11\x00\x00\x01\xA4\x00\xB2\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x04\xAC\x2A\x2C\x03\x2C\xBE\xB6\xE4\x00\x03\xAC\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xE4\x00\x05\xAC\x04\x00\x00\x00\x00\x00\x15\x00\xCB\x64\x07\x00\x10\x02\xB3\x00\x8C\x00\xCB\x64\x07\x00\x17\x02\xB3\x00\x68\x00\xB1\x00\x01\x00\x1A\x01\x43\x01\x46\x01\x20\x00\x28\x00\x06\x00\x0E\x00\x20\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x02\x00\x00\x00\x53\x55\x43\x43\x45\x53\x53\x46\x41\x49\x4C\x55\x52\x45\x00\x00\x54\x02\x00\x00\x3E\x05\x00\x00\x78\x02\x00\x00\x00\x00\x00\x00\x7E\x02\x00\x00\x00\x00\x00\x00\xAC\x02\x00\x00\x00\x00\x00\x00\xE2\x02\x00\x00\x00\x00\x00\x00\x01\x00\x0C\x01\x25\x00\x0B\x00\x1A\x01\x63\x00\x1F\x01\x64\x00\x24\x01\x65\x00\x2E\x01\x66\x00\x38\x01\x67\x00\x43\x01\x6B\x00\x46\x01\x69\x00\x47\x01\x6A\x00\x49\x01\x6C\x00\x4E\x01\x6D\x00\x50\x01\x6E\x00\x0D\x00\x5A\x01\x44\x00\x68\x01\x47\x00\x6D\x01\x48\x00\x72\x01\x49\x00\x82\x01\x4B\x00\x8E\x01\x4C\x00\x90\x01\x4F\x00\xA4\x01\x50\x00\xB0\x01\x51\x00\xB2\x01\x53\x00\xBA\x01\x54\x00\xBC\x01\x57\x00\xC8\x01\x58\x00\x02\x00\xD2\x01\x35\x00\xDC\x01\x36\x00\x01\x00\x02\x00\x03\x00\x00\x00\xB0\x03\x00\x00\xCC\x03\x00\x00\xE0\x03\x00\x00\xF0\x03\x00\x00\xFC\x03\x00\x00\x02\x04\x00\x00\x0E\x04\x00\x00\x1C\x04\x00\x00\x28\x04\x00\x00\x49\x05\x00\x00\x36\x04\x00\x00\x49\x05\x00\x00\x44\x04\x00\x00\x49\x05\x00\x00\x62\x04\x00\x00\x49\x05\x00\x00\x72\x04\x00\x00\x49\x05\x00\x00\x7C\x04\x00\x00\x4A\x05\x00\x00\x8C\x04\x00\x00\x49\x05\x00\x00\x9E\x04\x00\x00\x49\x05\x00\x00\xA8\x04\x00\x00\x4A\x05\x00\x00\xB8\x04\x00\x00\x49\x05\x00\x00\xC4\x04\x00\x00\x4C\x05\x00\x00\xCE\x04\x00\x00\x4C\x05\x00\x00\xD6\x04\x00\x00\x50\x05\x00\x00\xEE\x04\x00\x00\x54\x05\x00\x00\xFE\x04\x00\x00\x5A\x05\x00\x00\x10\x05\x00\x00\x62\x05\x00\x00\x20\x05\x00\x00\x6A\x05\x00\x00\x30\x05\x00\x00\x72\x05\x00\x00\x1B\x00\x00\x00\x02\x00\x00\x00\x07\x00\x00\x00\x1A\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x61\x70\x70\x73\x2E\x62\x69\x73\x74\x50\x61\x63\x6B\x61\x67\x65\x12\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x6C\x61\x6E\x67\x75\x74\x69\x6C\x0E\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x75\x74\x69\x6C\x09\x00\x6A\x61\x76\x61\x2E\x6C\x61\x6E\x67\x00\x04\x00\x42\x69\x73\x74\x0A\x00\x41\x72\x72\x61\x79\x55\x74\x69\x6C\x73\x0B\x00\x49\x6E\x74\x65\x6C\x41\x70\x70\x6C\x65\x74\x00\x09\x00\x45\x78\x63\x65\x70\x74\x69\x6F\x6E\x00\x0C\x00\x41\x52\x52\x41\x59\x5F\x4C\x45\x4E\x47\x54\x48\x0C\x00\x43\x4F\x4E\x53\x54\x5F\x4E\x55\x4D\x42\x45\x52\x1C\x00\x43\x4F\x50\x59\x5F\x43\x4F\x4D\x50\x41\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x0D\x00\x45\x43\x48\x4F\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x00\x07\x00\x46\x41\x49\x4C\x55\x52\x45\x00\x0E\x00\x46\x41\x49\x4C\x55\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x10\x00\x4D\x41\x58\x5F\x49\x4E\x50\x55\x54\x5F\x4C\x45\x4E\x47\x54\x48\x07\x00\x53\x55\x43\x43\x45\x53\x53\x00\x0E\x00\x53\x55\x43\x43\x45\x53\x53\x5F\x42\x55\x46\x46\x45\x52\x09\x00\x57\x52\x4F\x4E\x47\x5F\x43\x49\x44\x00\x08\x00\x3C\x63\x6C\x69\x6E\x69\x74\x3E\x06\x00\x3C\x69\x6E\x69\x74\x3E\x15\x00\x63\x6F\x70\x79\x43\x6F\x6D\x70\x61\x72\x65\x42\x75\x66\x66\x65\x72\x54\x65\x73\x74\x00\x0D\x00\x69\x6E\x76\x6F\x6B\x65\x43\x6F\x6D\x6D\x61\x6E\x64\x00\x10\x00\x63\x6F\x6D\x70\x61\x72\x65\x42\x79\x74\x65\x41\x72\x72\x61\x79\x0D\x00\x63\x6F\x70\x79\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0D\x00\x66\x69\x6C\x6C\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0B\x00\x73\x65\x74\x52\x65\x73\x70\x6F\x6E\x73\x65\x00\x09\x00\x42\x69\x73\x74\x2E\x6A\x61\x76\x61\x02\x64\x00\x00\x00\x00\x00\x00\x00\x02\x00\x02\x00\x02\x64\x02\x00\x05\x00\x64\x02\x64\x02\x02\x08\x05\x00\x64\x02\x64\x02\x02\x00\x04\x00\x64\x02\x02\x04\x00\x00\x03\x00\x64\x02\x02\x00"
#define PROD_APP_LEN_SIG_VER_1 2784
#define PROD_APP_BLOB_SIG_VER_2 "\x06\x00\x00\x00\xE1\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x86\x80\x00\x00\x27\x07\x10\x20\x17\x01\x00\x00\x60\x00\x00\x00\x60\x00\x00\x00\x01\x00\x00\x00\x43\x53\x45\x58\x02\x00\x00\x00\xBD\x2F\xBA\x36\xA2\xD6\x4D\xAB\x93\x90\xFF\x6D\xA2\xFE\xF3\x1C\x08\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x57\x21\x06\x03\xB4\x67\x17\x12\x26\xFA\x50\x50\x81\x0E\x15\x86\xD9\x91\xA6\x2A\xDB\xE0\x35\x37\xB4\x6E\x91\x20\x01\x2B\x5A\xF7\xCC\x7F\x06\x5A\xEC\xC5\x65\xD5\x5A\x1A\x1D\xD9\x0D\xB8\xB4\xDF\xC0\xC2\x9A\x77\x8D\x04\x2B\xF0\xED\xF8\x15\xB2\xCB\xAC\x45\x32\xAB\xC6\x9F\x45\xDF\x1A\x0B\x7B\x26\xBC\xED\xD0\xE3\xCE\x2B\xAA\x47\xD9\x77\x9A\x5E\x6A\xFB\xA1\x7C\xCD\x33\xD9\xA2\x38\xCD\x29\x7A\x47\xE8\xB5\xCD\x21\x56\x6C\x72\xB5\xEF\x25\xE4\xB6\xD1\x5F\x96\x00\xA2\x00\x73\x0D\xAF\x50\x81\xBD\xC3\xCA\xC6\x8A\xB2\x59\x49\x19\x91\x37\x88\x33\x9B\x38\x42\x48\x9D\x91\xA8\xCD\x2C\x1F\xA6\x6B\xFA\x25\x30\xB0\xEE\xA7\x27\x80\xB2\x32\x04\x5B\x10\x31\xC2\xD9\xE2\x52\xDD\x5E\x0F\xE4\xE8\xDB\xE4\x42\x46\x37\xEE\x52\xB6\x05\xFB\x7C\x37\xEE\xBD\xA6\xAF\x27\xBF\xA6\xDF\x52\x16\xE1\x55\xC5\x72\xB8\x4B\x22\x59\x96\xEE\x80\xDA\x1A\xC1\x5A\x83\xC1\xC8\x7E\x4C\x9F\x73\x87\x73\x55\xB5\x15\xF8\xC3\x54\x82\x74\x17\x54\x4E\x5F\x97\x5D\x3D\xAA\x71\xEF\x48\xC7\x66\x9C\x0B\x41\xA0\xF5\x9E\x70\xF4\x60\xD8\x8D\x9F\x3E\x58\x52\x71\x41\xC5\x5B\xA3\x7A\xB2\x02\x97\xB1\x2E\x01\x5D\xC6\x18\x90\x54\xA2\xCE\xB3\x75\xF3\xE4\x13\xDF\x22\xED\x3D\x16\x60\x59\x1F\x9F\xF7\x53\x01\x97\xBB\x7D\x94\xE7\x6D\x3B\x7A\x30\x2B\x07\xF4\x6B\xAF\x4D\x10\x5F\x92\x36\xDE\xD7\xE1\x37\x05\x3E\x9E\xB4\xF2\x14\x10\xD3\xD4\xDD\x55\xED\xC6\x82\x25\x02\x4D\xAD\xAA\x75\xEC\x2D\xAD\x6E\x23\xAD\x2C\xA7\x3A\x23\xC3\xA4\x56\x69\x18\xF9\xC0\x87\xD5\x48\x19\xD3\x8A\xB3\x3E\xB5\x3C\x04\x5B\xD7\xFB\x3D\x2E\x89\x53\xBA\x6C\xCA\xC7\x10\x52\x31\x08\xAB\xDA\x6F\xBD\x53\x70\x63\xEE\xB9\x8D\xCA\x01\x00\x01\x00\xB8\x58\x0B\xBE\x2C\xE1\x67\xF4\xC3\x45\xFB\x3D\xED\x42\xB8\xC2\x28\x4B\x26\x68\x2A\x09\xA2\x18\xF5\xC7\xF6\x4D\x0B\xCB\x14\x4F\x38\x83\xA2\x58\x35\xCC\xF7\x5D\x31\x99\x05\x52\x85\x2A\xA2\x66\xF3\xA6\x54\x3E\x5D\xBD\xCB\x1D\x60\xEF\x1B\x29\x80\xD6\xAF\x22\x9B\x8F\xC3\x4F\x5B\x7C\x07\x90\x82\x20\x9F\x9C\x45\xE2\xDF\xC3\x33\x48\x78\xB0\x83\x0E\x73\x90\xB7\xC3\xBC\x7B\x47\x9F\x10\x29\xA5\x95\xBD\x37\x58\x5C\x00\x25\x8F\xF2\xD3\x79\xDC\xA5\x90\xA1\xA8\x60\x23\xDF\x28\xB8\xE2\x41\x6F\x3D\xAA\x4D\x30\x7D\x88\x40\x16\x54\x5E\x56\x3E\x76\x97\x69\xE9\xF0\x4B\xC4\xE8\xCC\xE6\x29\x01\x33\x0E\x3C\x2B\x0E\x00\xD2\x8F\x85\xB3\x78\x10\x97\xFB\x0D\x06\xE9\xCF\x63\x48\x1A\xE9\x41\x36\x20\xEA\x8B\x60\xCC\x0C\x79\xDA\xE2\x89\xF6\xD6\x4B\xB6\x07\x8D\x1D\x4D\xB1\x5E\x9D\xD0\x61\x23\xD6\x52\xF0\x63\x71\x42\xDE\x84\x7B\x5F\x38\xF3\xFF\x9E\xBC\xE5\x0C\xB2\x18\x1C\x97\x05\xD0\xBF\x87\xBA\xF2\xF4\xFC\x4E\xC5\x20\xE0\x01\x2E\x25\x48\xC8\xF2\xE1\x90\x27\xEF\xA2\x13\x4C\x62\xB8\xA4\x98\x4F\x74\xDE\x5F\xA2\x6A\x39\x6B\xE5\xE7\x6A\xAC\xDB\xB1\xF5\xF5\xC2\x21\x9E\x2F\xF4\xBC\xE2\x62\x4B\xFD\x29\xC0\x54\xD1\xAA\x45\x67\xA0\x10\x9C\x75\xF6\x5C\x5D\x4D\xBB\x6A\x0B\x68\x57\x78\x4D\xB9\x77\xAB\xA8\x71\x8B\x59\xC6\x63\x47\x46\xC3\x86\xFF\x09\x21\x56\xFD\x46\x1B\xB8\xB3\xF1\xF8\x37\xD1\xB4\x81\x57\xB3\x30\x85\xDE\x38\xEC\x3D\xD8\x1A\x53\x54\xD1\x2C\x7A\x10\x61\xDE\x99\x91\x91\x1C\x86\xC4\xE5\x1F\x83\xC2\x57\x57\x4F\xE4\x95\x8C\x4E\xA0\x53\xA4\x25\x97\x2F\x53\x01\x6E\xE9\x8E\x8C\x23\x2F\x8C\xBC\x78\x21\xDB\x75\x5B\x48\x49\x59\xA2\xAB\x94\x53\x41\x72\x00\x00\x00\x00\x42\x41\x43\x50\x01\x00\x00\x00\xD4\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x20\x00\x00\x00\x8C\x00\x00\x00\x04\x00\x00\x00\x63\x00\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x2E\x30\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x00\x00\x00\x03\x00\x00\x00\x5D\x28\x01\xFA\xAE\x61\xFA\x12\x55\x0F\x64\xC9\x2A\x45\xCA\xD4\x60\x5B\xFB\xDA\xC6\xD8\x96\x06\x1A\x5B\xB6\x3C\xDF\xF5\x4B\x7A\x0B\x8A\x4D\xAA\x72\xC0\x5C\x13\xCF\x50\xE5\x2B\x23\x6A\x0D\x83\xDD\xDD\xDD\xDD\x20\x4E\x00\x00\x00\x00\x00\x00\x10\x00\x00\x00\x00\x00\x00\x00\xFF\xFF\xFF\xFF\x00\x00\x00\x00\x00\x00\x00\x00\x0B\x00\x00\x00\x73\x01\x00\x00\x69\x6E\x74\x00\x73\x65\x63\x75\x72\x69\x74\x79\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x77\x72\x69\x74\x74\x65\x6E\x2E\x62\x79\x2E\x69\x6E\x74\x65\x6C\x00\x74\x72\x75\x65\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x72\x73\x69\x6F\x6E\x00\x31\x2E\x30\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x76\x65\x6E\x64\x6F\x72\x00\x49\x6E\x74\x65\x6C\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x70\x6C\x61\x74\x66\x6F\x72\x6D\x00\x43\x53\x45\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x6E\x61\x6D\x65\x00\x62\x69\x73\x74\x20\x61\x70\x70\x6C\x65\x74\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x66\x6C\x61\x73\x68\x2E\x71\x75\x6F\x74\x61\x00\x30\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x65\x6E\x74\x72\x79\x5F\x63\x6C\x61\x73\x73\x00\x62\x69\x73\x74\x2E\x42\x69\x73\x74\x00\x73\x74\x72\x69\x6E\x67\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x73\x63\x72\x69\x70\x74\x69\x6F\x6E\x00\x49\x6E\x74\x65\x6C\x28\x52\x29\x20\x44\x79\x6E\x61\x6D\x69\x63\x20\x41\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x20\x4C\x6F\x61\x64\x65\x72\x20\x65\x78\x74\x65\x6E\x64\x65\x64\x20\x74\x65\x73\x74\x20\x61\x70\x70\x6C\x69\x63\x61\x74\x69\x6F\x6E\x00\x62\x6F\x6F\x6C\x00\x61\x70\x70\x6C\x65\x74\x2E\x64\x65\x62\x75\x67\x2E\x65\x6E\x61\x62\x6C\x65\x00\x66\x61\x6C\x73\x65\x00\x69\x6E\x74\x00\x61\x70\x70\x6C\x65\x74\x2E\x61\x70\x69\x2E\x6C\x65\x76\x65\x6C\x00\x37\x00\x00\x00\x00\x00\x00\xDD\xDD\xDD\xDD\x4A\x45\x46\x46\x01\x00\x00\x00\xE2\x04\x00\x00\x00\x00\x04\x00\x01\x00\x04\x00\x0A\x00\x00\x00\x09\x00\x00\x00\x00\x00\x00\x00\x66\x02\x00\x00\x24\x03\x00\x00\x00\x00\x00\x00\x30\x00\x00\x00\x20\x00\x00\x00\x21\x00\x00\x00\xD8\x00\x00\x00\x28\x00\xA4\x00\x00\x00\xE4\x00\x1E\x00\x08\x02\x24\x00\x00\x00\xA8\x00\x04\x00\x00\x00\x03\x00\x02\x00\x01\x00\x0A\x00\x00\x00\x00\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x10\x02\x01\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x14\x02\x02\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x18\x02\x03\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x1C\x02\x04\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x1C\x02\x05\x00\x00\x00\x20\x00\x64\x01\x1A\x00\x00\x00\x06\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x20\x02\x07\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x18\x02\x08\x00\x00\x00\x20\x00\x64\x01\x1A\x00\x00\x00\x09\x00\x00\x00\x20\x00\x02\x00\x1A\x00\x24\x02\x05\x00\x00\x00\x01\x00\x00\x00\x20\x00\x01\x00\x01\x00\x10\x01\x02\x00\x00\x00\x20\x00\x01\x00\x02\x00\x1E\x01\x03\x00\x00\x00\x20\x00\x03\x00\x01\x00\x5E\x01\x04\x00\x00\x00\x20\x00\x02\x00\x01\x00\xD6\x01\x00\x00\x00\x00\x20\x00\x00\x00\x08\x00\xE0\x01\x05\x00\x00\x00\x01\x00\x00\x00\x24\x00\x00\x00\x08\x00\x00\x00\x20\x00\x00\x00\x07\x00\x00\x00\x26\x00\x00\x00\x06\x00\x00\x00\x26\x00\x00\x00\x05\x00\x00\x00\x26\x00\x00\x00\x01\x00\x01\x00\x00\x00\x05\x00\x2A\xB7\xE8\x00\xB1\x00\x05\x00\x04\x00\xFE\x01\x38\x00\x10\x20\xBC\x64\x4D\x10\x20\xBC\x64\x4E\x2C\x03\x10\x20\x10\x08\xB8\x00\xF8\x00\x2C\x03\x2D\x03\x10\x20\xB8\x00\x00\x01\x2C\x03\x2D\x03\x10\x20\xB8\x00\x08\x01\x3C\xA7\x55\x01\x4D\x03\x3C\x1B\x99\x00\x5C\x01\x03\xAC\x04\xAC\x04\x00\x04\x00\x00\x00\x70\x00\x1B\xCC\xC8\x01\x02\x00\x00\x00\x01\x00\x74\x01\x9C\x01\x2A\xB7\xB4\x00\x3E\x1D\x9A\x00\x8E\x01\x2A\xB2\x8C\x00\x03\xB2\x8C\x00\xBE\xB6\xF0\x00\xA7\x00\x9A\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xF0\x00\x1D\xAC\x2C\xC6\xB0\x01\x2C\xBE\x9E\x00\xB0\x01\x2C\xBE\x11\x00\x00\x01\xA4\x00\xBE\x01\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xF0\x00\x04\xAC\x2A\x2C\x03\x2C\xBE\xB6\xF0\x00\x03\xAC\x2A\xB2\x68\x00\x03\xB2\x68\x00\xBE\xB6\xF0\x00\x05\xAC\x01\x00\x02\x00\x00\x00\x02\x00\x03\xAC\x04\x00\x00\x00\x00\x00\x15\x00\xCB\x64\x07\x00\x28\x02\xB3\x00\x8C\x00\xCB\x64\x07\x00\x2F\x02\xB3\x00\x68\x00\xB1\x00\x01\x00\x26\x01\x4F\x01\x52\x01\x22\x00\x28\x00\x06\x00\x0E\x00\x00\x00\x20\x00\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x02\x00\x00\x00\x53\x55\x43\x43\x45\x53\x53\x46\x41\x49\x4C\x55\x52\x45\x01\x00\x02\x00\x03\x00\x30\x03\x00\x00\x36\x03\x00\x00\x4A\x03\x00\x00\x5A\x03\x00\x00\x66\x03\x00\x00\x6C\x03\x00\x00\x78\x03\x00\x00\x86\x03\x00\x00\x92\x03\x00\x00\xAF\x04\x00\x00\xA0\x03\x00\x00\xAF\x04\x00\x00\xAE\x03\x00\x00\xAF\x04\x00\x00\xCC\x03\x00\x00\xAF\x04\x00\x00\xDC\x03\x00\x00\xAF\x04\x00\x00\xE6\x03\x00\x00\xB0\x04\x00\x00\xF6\x03\x00\x00\xAF\x04\x00\x00\x08\x04\x00\x00\xAF\x04\x00\x00\x12\x04\x00\x00\xB0\x04\x00\x00\x22\x04\x00\x00\xAF\x04\x00\x00\x2E\x04\x00\x00\xB2\x04\x00\x00\x38\x04\x00\x00\xB2\x04\x00\x00\x40\x04\x00\x00\xB6\x04\x00\x00\x58\x04\x00\x00\xBA\x04\x00\x00\x68\x04\x00\x00\xC0\x04\x00\x00\x70\x04\x00\x00\xC4\x04\x00\x00\x82\x04\x00\x00\xCC\x04\x00\x00\x92\x04\x00\x00\xD4\x04\x00\x00\xA2\x04\x00\x00\xDC\x04\x00\x00\x1B\x00\x00\x00\x02\x00\x00\x00\x08\x00\x00\x00\x04\x00\x62\x69\x73\x74\x12\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x6C\x61\x6E\x67\x75\x74\x69\x6C\x0E\x00\x63\x6F\x6D\x2E\x69\x6E\x74\x65\x6C\x2E\x75\x74\x69\x6C\x09\x00\x6A\x61\x76\x61\x2E\x6C\x61\x6E\x67\x00\x04\x00\x42\x69\x73\x74\x0A\x00\x41\x72\x72\x61\x79\x55\x74\x69\x6C\x73\x0B\x00\x49\x6E\x74\x65\x6C\x41\x70\x70\x6C\x65\x74\x00\x09\x00\x45\x78\x63\x65\x70\x74\x69\x6F\x6E\x00\x0C\x00\x41\x52\x52\x41\x59\x5F\x4C\x45\x4E\x47\x54\x48\x0C\x00\x43\x4F\x4E\x53\x54\x5F\x4E\x55\x4D\x42\x45\x52\x1C\x00\x43\x4F\x50\x59\x5F\x43\x4F\x4D\x50\x41\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x0D\x00\x45\x43\x48\x4F\x5F\x54\x45\x53\x54\x5F\x43\x49\x44\x00\x07\x00\x46\x41\x49\x4C\x55\x52\x45\x00\x0E\x00\x46\x41\x49\x4C\x55\x52\x45\x5F\x42\x55\x46\x46\x45\x52\x10\x00\x4D\x41\x58\x5F\x49\x4E\x50\x55\x54\x5F\x4C\x45\x4E\x47\x54\x48\x07\x00\x53\x55\x43\x43\x45\x53\x53\x00\x0E\x00\x53\x55\x43\x43\x45\x53\x53\x5F\x42\x55\x46\x46\x45\x52\x09\x00\x57\x52\x4F\x4E\x47\x5F\x43\x49\x44\x00\x08\x00\x3C\x63\x6C\x69\x6E\x69\x74\x3E\x06\x00\x3C\x69\x6E\x69\x74\x3E\x15\x00\x63\x6F\x70\x79\x43\x6F\x6D\x70\x61\x72\x65\x42\x75\x66\x66\x65\x72\x54\x65\x73\x74\x00\x0D\x00\x69\x6E\x76\x6F\x6B\x65\x43\x6F\x6D\x6D\x61\x6E\x64\x00\x06\x00\x6F\x6E\x49\x6E\x69\x74\x10\x00\x63\x6F\x6D\x70\x61\x72\x65\x42\x79\x74\x65\x41\x72\x72\x61\x79\x0D\x00\x63\x6F\x70\x79\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0D\x00\x66\x69\x6C\x6C\x42\x79\x74\x65\x41\x72\x72\x61\x79\x00\x0B\x00\x73\x65\x74\x52\x65\x73\x70\x6F\x6E\x73\x65\x02\x64\x00\x00\x00\x00\x00\x00\x00\x02\x00\x02\x00\x02\x64\x02\x00\x01\x00\x64\x02\x05\x00\x64\x02\x64\x02\x02\x08\x05\x00\x64\x02\x64\x02\x02\x00\x04\x00\x64\x02\x02\x04\x00\x00\x03\x00\x64\x02\x02\x00"
#define PROD_APP_LEN_SIG_VER_2 2786
#define INTEL_SD_UUID "BD2FBA36A2D64DAB9390FF6DA2FEF31C"
#define TX_LEN 8
#define RX_LEN 8


bool getAppletBlobAccordingToSigVer(dal_tee_metadata &teeMetadata, char** prod_app_blob, uint32_t* prod_app_len)
{
	switch (teeMetadata.sig_version)
	{
	case 0:
	case 1:
		*prod_app_blob = PROD_APP_BLOB_SIG_VER_1;
		*prod_app_len = PROD_APP_LEN_SIG_VER_1;
		break;
	case 2:
		*prod_app_blob = PROD_APP_BLOB_SIG_VER_2;
		*prod_app_len = PROD_APP_LEN_SIG_VER_2;
		break;
	default:
		cout << "Could not get DAL signature version using TEE_QueryTEEMetadata." << endl;
		return false;
	}

	return true;
}


int main()
{
    JHI_RET status = JHI_UNKNOWN_ERROR;
    JHI_HANDLE jhi_handle = NULL;
    JHI_SESSION_HANDLE app_session_handle = NULL;
	SD_SESSION_HANDLE sd_session_handle = NULL;

    uint8_t txbuf[TX_LEN] = {0};
    uint8_t rxbuf[RX_LEN] = {0};

    JVM_COMM_BUFFER comm_buffer;

	dal_tee_metadata teeMetadata;
	char* prod_app_blob = NULL;
	uint32_t prod_app_len = 0;

    comm_buffer.TxBuf->length = TX_LEN;
    comm_buffer.TxBuf->buffer = txbuf;
    comm_buffer.RxBuf->length = RX_LEN;
    comm_buffer.RxBuf->buffer = rxbuf;

    do
	{
		/*
		 * TEE_Management test
		 */

		// Open an Intel SD session
		cout << "Opening Intel SD session...";
		status = TEE_OpenSDSession(INTEL_SD_UUID, &sd_session_handle);
		if (!CheckTeeSuccess(status, "TEE_OpenSDSession")) break;

		// Get TEE metadata
		cout << "Quering TEE metadata...";
		status = TEE_QueryTEEMetadata(sd_session_handle, &teeMetadata);
		if (!CheckTeeSuccess(status, "TEE_QueryTEEMetadata")) break;

		if (!getAppletBlobAccordingToSigVer(teeMetadata, &prod_app_blob, &prod_app_len))
		{
			status = TEE_STATUS_INTERNAL_ERROR;
			break;
		}

		// Install using teemanagement
		cout << "Installing the production BIST applet...";
		status = TEE_SendAdminCmdPkg(sd_session_handle, (uint8_t*) prod_app_blob, prod_app_len);
		if (!CheckTeeSuccess(status, "TEE_SendAdminCmdPkg")) break;

		// Close the Intel SD session
		cout << "Closing the Intel SD session...";
		status = TEE_CloseSDSession(&sd_session_handle);
		if (!CheckTeeSuccess(status, "TEE_CloseSDSession")) break;

		/*
		 * JHI lib test
		 */

		// Init
        cout << "Initializing JHI...";
        status = JHI_Initialize(&jhi_handle, 0, 0);
        if (!CheckJhiSuccess(status, "JHI_Initialize")) break;

        // Create a session
        cout << "Creating a session...";
        status = JHI_CreateSession(jhi_handle, PROD_APP_ID, 0, NULL, &app_session_handle);
        if (!CheckJhiSuccess(status, "JHI_CreateSession")) break;

		/*
		 * Functional test
		 */

		// Run the compare buffer test
		cout << "Running the Compare Buffer test...";
		status = JHI_SendAndRecv2(jhi_handle, app_session_handle, 0, &comm_buffer, NULL);
		if (!CheckJhiSuccess(status, "JHI_SendAndRecv2")) break;

		// Make sure the Compare Buffer test passed
		cout << "Making sure the Compare Buffer test passed...";
		if(memcmp("SUCCESS", comm_buffer.RxBuf->buffer, 7)) // not equal
		{
			cout << "Fail.\nCompare Buffer test failed. Received buffer: "<< comm_buffer.RxBuf->buffer << endl;
			status = JHI_UNKNOWN_ERROR;
			break;
		}
		else
			cout << " Success." << endl;

		// Run the echo test
		cout << "Running the Echo test...";
		comm_buffer.RxBuf->length = RX_LEN;
		memcpy(comm_buffer.TxBuf->buffer, "ECHOBUF", 7);
		status = JHI_SendAndRecv2(jhi_handle, app_session_handle, 1, &comm_buffer, NULL);
		if (!CheckJhiSuccess(status, "JHI_SendAndRecv2")) break;

		// Make sure the Echo test passed
		cout << "Making sure the Echo test passed...";
		if(memcmp("ECHOBUF", comm_buffer.RxBuf->buffer, 7)) // not equal
		{
			cout << "\nEcho test failed. Received buffer: "<< comm_buffer.RxBuf->buffer << endl;
			status = JHI_UNKNOWN_ERROR;
			break;
		}
		else
			cout << " Success." << endl;

		/*
		 * Teardown
		 */

        // Close session
        cout << "Closing the session...";
        status = JHI_CloseSession(jhi_handle, &app_session_handle);
        if (!CheckJhiSuccess(status, "JHI_CloseSession")) break;

        // Uninstall
        cout << "Uninstalling...";
        status = JHI_Uninstall(jhi_handle, PROD_APP_ID);
        if (!CheckJhiSuccess(status, "JHI_Uninstall")) break;

        // Deinit
        cout << "Deinitilizing JHI...";
        status = JHI_Deinit(jhi_handle);
        if (!CheckJhiSuccess(status, "JHI_Deinit")) break;
    } while (0);

	return status == JHI_SUCCESS ? 0 : 1;
}

